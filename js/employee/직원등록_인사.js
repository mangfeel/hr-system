/**
 * ì§ì›ë“±ë¡_ì¸ì‚¬.js - í”„ë¡œë•ì…˜ê¸‰ ë¦¬íŒ©í† ë§
 * 
 * ì‹ ê·œ ì§ì› ë“±ë¡ ë° í˜¸ë´‰ ê³„ì‚°
 * - ì§ì› ê¸°ë³¸ ì •ë³´ ì…ë ¥
 * - ê³¼ê±° ê²½ë ¥ ê´€ë¦¬ (ì¶”ê°€/ì‚­ì œ)
 * - í˜¸ë´‰ ìë™ ê³„ì‚° (ì¸ì •ë¥  + ê·¼ë¬´ì‹œê°„ ë¹„ìœ¨)
 * - ì²«ìŠ¹ê¸‰ì¼/ì°¨ê¸°ìŠ¹ê¸‰ì¼ ê³„ì‚°
 * - ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„ ê´€ë¦¬ â­ v3.2.0 ì¶”ê°€
 * - ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± â­ v3.3.0 ì¶”ê°€
 * - ê²½ë ¥ ì—†ìŒ í† ê¸€ â­ v3.4.1 ì¶”ê°€
 * - ë°œë ¹ ë°ì´í„° êµ¬ì¡° í†µì¼ â­ v3.4.2 ì¶”ê°€
 * - ê²€ì¦ ë° ì €ì¥
 * 
 * @version 4.1.0
 * @since 2024-11-04
 * 
 * [ë³€ê²½ ì´ë ¥]
 * v4.1.0 (2026-01-22) â­ ê²€ì¦ API ì—°ë™
 *   - Validator.validateEmployeeRegistration â†’ API_ì¸ì‚¬.validateRegistration
 *   - ì„œë²„ APIë¡œ ê²€ì¦ ë¡œì§ ë³´í˜¸
 * 
 * v4.0.0 (2026-01-21) â­ API ì—°ë™ ë²„ì „
 *   - calculateAndSave() async ë³€ê²½
 *   - í˜¸ë´‰ ê³„ì‚° API ìš°ì„  ì‚¬ìš© (API_ì¸ì‚¬)
 *   - ì„œë²„ APIë¡œ ê³„ì‚° ë¡œì§ ë³´í˜¸
 * 
 * v3.4.2 (2025-12-10) â­ ì‹ ê·œ ë°œë ¹ ë°ì´í„° êµ¬ì¡° ê°œì„ 
 *   - ë°œë ¹ ID: ìˆ«ì(1) â†’ ë¬¸ìì—´(assign-timestamp) ë³€ê²½
 *   - ë°œë ¹ ì½”ë“œ: 'ì‹ ê·œì„ìš©' â†’ 'ê³ ìœ ë²ˆí˜¸-01' íŒ¨í„´ (ì˜ˆ: H105-01)
 *   - startDate í•„ë“œ ì¶”ê°€ (ì¸ì‚¬ë°œë ¹ ëª¨ë“ˆê³¼ ë™ì¼)
 *   - paymentMethod, isRankBased, status í•„ë“œ ì¶”ê°€
 *   - ê¸°ì¡´ date, type í•„ë“œëŠ” í•˜ìœ„ í˜¸í™˜ìš©ìœ¼ë¡œ ìœ ì§€
 * 
 * v3.4.1 (2025-12-05) â­ UI ê°œì„  - ì¹´ë“œ í†µí•© ë° ê²½ë ¥ ì—†ìŒ í† ê¸€
 *   - 6ê°œ ì¹´ë“œ â†’ 3ê°œ ì¹´ë“œë¡œ í†µí•© (HTML ìˆ˜ì •)
 *   - toggleCareerSection() í•¨ìˆ˜ ì¶”ê°€
 *   - "ê²½ë ¥ ì—†ìŒ" ì²´í¬ ì‹œ ê²½ë ¥ ì…ë ¥ í¼ ìˆ¨ê¹€
 *   - resetRegisterForm()ì— ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” ì¶”ê°€
 * 
 * v3.4.0 (2025-12-05) â­ ì›”ì†Œì •ê·¼ë¡œì‹œê°„ ê³„ì‚° ê³µí†µí™”
 *   - calculateMonthlyWorkingHours()ê°€ SalaryCalculator.getMonthlyWorkingHours() í˜¸ì¶œ
 *   - ê¸‰ì—¬ì„¤ì •ì˜ ì†Œìˆ˜ì  ì²˜ë¦¬ ë°©ì‹(ì˜¬ë¦¼/ë°˜ì˜¬ë¦¼/ë²„ë¦¼) ì„¤ì • ë°˜ì˜
 *   - fallback: SalaryCalculator ì—†ì„ ì‹œ ë°˜ì˜¬ë¦¼ ì²˜ë¦¬
 * 
 * v3.3.0 (2025-12-04) â­ ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± ê¸°ëŠ¥ ì¶”ê°€
 *   - updateEmployeeNumberField() í•¨ìˆ˜ ì¶”ê°€
 *   - ì…ì‚¬ì¼ ë³€ê²½ ì‹œ ì‚¬ì›ë²ˆí˜¸ ìë™ ì—…ë°ì´íŠ¸
 *   - í˜•ì‹: YYYY-NNNN (ì…ì‚¬ ì—°ë„ ê¸°ì¤€)
 *   - ë¹ˆ ë²ˆí˜¸ ì¬ì‚¬ìš©, ìˆ˜ë™ ì…ë ¥ í—ˆìš©
 * 
 * v3.2.0 (2025-12-01) â­ ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„ í•„ë“œ ì¶”ê°€ (ê¸‰ì—¬ ê´€ë¦¬ ëŒ€ë¹„)
 *   - ì§ì› ë“±ë¡ ì‹œ "ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„" ì…ë ¥ í•„ë“œ ì¶”ê°€ (ê¸°ë³¸ê°’ 40ì‹œê°„)
 *   - ì›” ì†Œì •ê·¼ë¡œì‹œê°„ ìë™ ê³„ì‚° ë° í‘œì‹œ
 *   - employment.weeklyWorkingHoursì— ì €ì¥
 *   - ì²« ë²ˆì§¸ ë°œë ¹ì— workingHours ì €ì¥
 *   - calculateMonthlyWorkingHours() í•¨ìˆ˜ ì¶”ê°€
 *   - updateMonthlyHoursDisplay() í•¨ìˆ˜ ì¶”ê°€
 * 
 * v3.1.0 (2025-11-26) â­ ì£¼ë‹¹ê·¼ë¬´ì‹œê°„ ë¹„ìœ¨ ì ìš©
 *   - ê²½ë ¥ ì…ë ¥ í¼ì— "ì£¼ë‹¹ê·¼ë¬´ì‹œê°„" í•„ë“œ ì¶”ê°€ (1~40ì‹œê°„)
 *   - ê²½ë ¥ ê³„ì‚° ì‹œ ê·¼ë¬´ì‹œê°„ ë¹„ìœ¨ ì ìš©
 *   - careerDetailsì— workingHours ì €ì¥
 *   - í™˜ì‚°ê³µì‹: ì‹¤ì œê¸°ê°„ Ã— (ì¸ì •ë¥ /100) Ã— (ê·¼ë¬´ì‹œê°„/40)
 * 
 * v3.0 - í”„ë¡œë•ì…˜ê¸‰ ë¦¬íŒ©í† ë§
 *   - Phase 1 ìœ í‹¸ë¦¬í‹° ì ìš© (DOMìœ í‹¸, ì§ì›ìœ í‹¸)
 *   - ì™„ë²½í•œ ì—ëŸ¬ ì²˜ë¦¬
 *   - ì²´ê³„ì  ë¡œê¹…
 *   - JSDoc ì£¼ì„ ì¶”ê°€
 *   - XSS ë°©ì§€
 * 
 * [í•˜ìœ„ í˜¸í™˜ì„±]
 * - ëª¨ë“  ê¸°ì¡´ í•¨ìˆ˜ëª… ìœ ì§€
 * - ê¸°ì¡´ API 100% í˜¸í™˜
 * - ì „ì—­ í•¨ìˆ˜ ìœ ì§€
 * - ê¸°ì¡´ ì§ì› ë°ì´í„°: weeklyWorkingHours ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 40 ì ìš©
 * 
 * [ì˜ì¡´ì„±]
 * - ë°ì´í„°ë² ì´ìŠ¤_ì¸ì‚¬.js (db)
 * - ê²€ì¦_ì¸ì‚¬.js (Validator)
 * - í˜¸ë´‰ê³„ì‚°ê¸°_ì¸ì‚¬.js (DateUtils, TenureCalculator, RankCalculator, CareerCalculator)
 * - DOMìœ í‹¸_ì¸ì‚¬.js (DOMìœ í‹¸_ì¸ì‚¬) - ì„ íƒ
 * - ë¡œê±°_ì¸ì‚¬.js (ë¡œê±°_ì¸ì‚¬) - ì„ íƒ
 * - ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.js (ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬) - ì„ íƒ
 */

// ===== ì „ì—­ ë³€ìˆ˜ =====

/**
 * ì¶”ê°€ëœ ê²½ë ¥ ê°œìˆ˜
 * @type {number}
 */
let careerCount = 0;

/**
 * ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± ì—¬ë¶€ í”Œë˜ê·¸
 * @type {boolean}
 */
let _isEmployeeNumberAutoGenerated = true;

// ===== ì´ˆê¸°í™” í•¨ìˆ˜ =====

/**
 * ê³ ìœ ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸
 * ë‹¤ìŒ ìƒì„±ë  ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥ í•„ë“œì— í‘œì‹œ
 * 
 * @example
 * updateUniqueCodeField(); // 'H042' í‘œì‹œ
 */
function updateUniqueCodeField() {
    try {
        ë¡œê±°_ì¸ì‚¬?.debug('ê³ ìœ ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸');
        
        const uniqueCodeField = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
            ? DOMìœ í‹¸_ì¸ì‚¬.getById('uniqueCode')
            : document.getElementById('uniqueCode');
        
        if (!uniqueCodeField) {
            ë¡œê±°_ì¸ì‚¬?.warn('ê³ ìœ ë²ˆí˜¸ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        const nextCode = db.getNextUniqueCode();
        
        if (typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined') {
            DOMìœ í‹¸_ì¸ì‚¬.setValue(uniqueCodeField, nextCode);
        } else {
            uniqueCodeField.value = nextCode;
        }
        
        ë¡œê±°_ì¸ì‚¬?.debug('ê³ ìœ ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ', { nextCode });
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ê³ ìœ ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ê³ ìœ ë²ˆí˜¸ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

/**
 * ì‚¬ì›ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸ (ìë™ìƒì„±)
 * ì…ì‚¬ì¼ ì—°ë„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ì›ë²ˆí˜¸ ìƒì„±
 * 
 * @description
 * - í˜•ì‹: YYYY-NNNN (ì˜ˆ: 2026-0001)
 * - ì…ì‚¬ì¼ ë³€ê²½ ì‹œ ìë™ í˜¸ì¶œ
 * - ìˆ˜ë™ ì…ë ¥ ì‹œ ìë™ìƒì„± ë¹„í™œì„±í™”
 * - ë¹ˆ ë²ˆí˜¸ ì¬ì‚¬ìš© (ì‚­ì œëœ ë²ˆí˜¸ ì¤‘ ê°€ì¥ ì‘ì€ ê²ƒ)
 * 
 * @example
 * updateEmployeeNumberField(); // ì…ì‚¬ì¼ ê¸°ì¤€ ì‚¬ì›ë²ˆí˜¸ í‘œì‹œ
 */
function updateEmployeeNumberField() {
    try {
        ë¡œê±°_ì¸ì‚¬?.debug('ì‚¬ì›ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸');
        
        const employeeNumberField = document.getElementById('employeeNumber');
        const entryDateField = document.getElementById('entryDate');
        
        if (!employeeNumberField || !entryDateField) {
            ë¡œê±°_ì¸ì‚¬?.warn('ì‚¬ì›ë²ˆí˜¸ ë˜ëŠ” ì…ì‚¬ì¼ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        // ì…ì‚¬ì¼ì´ ì—†ìœ¼ë©´ ì²˜ë¦¬ ì•ˆ í•¨
        const entryDate = entryDateField.value;
        if (!entryDate) {
            ë¡œê±°_ì¸ì‚¬?.debug('ì…ì‚¬ì¼ ì—†ìŒ, ì‚¬ì›ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
            return;
        }
        
        // ìë™ìƒì„± ëª¨ë“œê°€ ì•„ë‹ˆê³  ì´ë¯¸ ê°’ì´ ìˆìœ¼ë©´ ê±´ë„ˆëœ€
        const currentValue = employeeNumberField.value.trim();
        if (!_isEmployeeNumberAutoGenerated && currentValue) {
            ë¡œê±°_ì¸ì‚¬?.debug('ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ, ì‚¬ì›ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
            return;
        }
        
        // ì…ì‚¬ ì—°ë„ ì¶”ì¶œ
        const entryYear = entryDate.substring(0, 4);
        
        // ì‚¬ì›ë²ˆí˜¸ ìƒì„±
        const newEmployeeNumber = db.generateEmployeeNumber(entryYear);
        
        employeeNumberField.value = newEmployeeNumber;
        _isEmployeeNumberAutoGenerated = true;
        
        ë¡œê±°_ì¸ì‚¬?.info('ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± ì™„ë£Œ', {
            entryYear,
            employeeNumber: newEmployeeNumber
        });
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ì‚¬ì›ë²ˆí˜¸ í•„ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ì‚¬ì›ë²ˆí˜¸ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

/**
 * ì‚¬ì›ë²ˆí˜¸ ìˆ˜ë™ ì…ë ¥ ì²˜ë¦¬
 * ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ë©´ ìë™ìƒì„± ë¹„í™œì„±í™”
 * 
 * @example
 * // HTML: oninput="onEmployeeNumberInput()"
 */
function onEmployeeNumberInput() {
    _isEmployeeNumberAutoGenerated = false;
    ë¡œê±°_ì¸ì‚¬?.debug('ì‚¬ì›ë²ˆí˜¸ ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ ì „í™˜');
}

/**
 * ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
 * 
 * @example
 * // HTML: onclick="generateEmployeeNumberManual()"
 */
function generateEmployeeNumberManual() {
    try {
        const entryDateField = document.getElementById('entryDate');
        
        if (!entryDateField || !entryDateField.value) {
            const msg = 'âš ï¸ ë¨¼ì € ì…ì‚¬ì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
            if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(msg);
            } else {
                alert(msg);
            }
            return;
        }
        
        // ìë™ìƒì„± ëª¨ë“œë¡œ ì „í™˜ í›„ ì—…ë°ì´íŠ¸
        _isEmployeeNumberAutoGenerated = true;
        updateEmployeeNumberField();
        
        ë¡œê±°_ì¸ì‚¬?.info('ì‚¬ì›ë²ˆí˜¸ ìˆ˜ë™ ìë™ìƒì„± ì™„ë£Œ');
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ì‚¬ì›ë²ˆí˜¸ ìˆ˜ë™ ìë™ìƒì„± ì‹¤íŒ¨', error);
    }
}

// ===== ê²½ë ¥ ê´€ë¦¬ í•¨ìˆ˜ =====

/**
 * ê²½ë ¥ ì…ë ¥ í¼ ì¶”ê°€
 * ê³¼ê±° ê²½ë ¥ì„ ì…ë ¥í•  ìˆ˜ ìˆëŠ” í¼ ì„¹ì…˜ ë™ì  ìƒì„±
 * 
 * @example
 * addCareer(); // ê²½ë ¥ ì…ë ¥ í¼ ì¶”ê°€
 */
function addCareer() {
    try {
        careerCount++;
        
        ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ì¶”ê°€', { careerCount });
        
        const careerList = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
            ? DOMìœ í‹¸_ì¸ì‚¬.getById('careerList')
            : document.getElementById('careerList');
        
        if (!careerList) {
            ë¡œê±°_ì¸ì‚¬?.error('ê²½ë ¥ ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            throw new Error('ê²½ë ¥ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ê²½ë ¥ í¼ HTML ìƒì„± (ê°œì„ ëœ UI)
        const careerHTML = `
            <div class="career-header">
                <div class="career-title">ğŸ“Œ ê²½ë ¥ ${careerCount}</div>
                <button class="btn btn-danger btn-small" onclick="removeCareer(${careerCount})" type="button">âœ• ì‚­ì œ</button>
            </div>
            <div class="form-group">
                <label>ê·¼ë¬´ì²˜/ê²½ë ¥ ë‚´ìš©</label>
                <input type="text" id="careerName-${careerCount}" class="form-control" placeholder="ì˜ˆ: OOë³µì§€ê´€, OOì£¼ê°„ë³´í˜¸ì„¼í„°">
                <small class="form-hint">ê²½ë ¥ìœ¼ë¡œ ì¸ì •ë  ê¸°ê´€ëª…ì´ë‚˜ ì—…ë¬´ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”</small>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ì‹œì‘ì¼</label>
                    <input type="date" id="careerStartDate-${careerCount}" class="form-control">
                    <small class="form-hint">ê·¼ë¬´ ì‹œì‘ì¼</small>
                </div>
                <div class="form-group">
                    <label>ì¢…ë£Œì¼</label>
                    <input type="date" id="careerEndDate-${careerCount}" class="form-control">
                    <small class="form-hint">ê·¼ë¬´ ì¢…ë£Œì¼</small>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ì¸ì •ë¥  (%)</label>
                    <input type="number" id="careerRate-${careerCount}" class="form-control" value="100" min="0" max="100" placeholder="100">
                    <small class="form-hint">ë™ì¢…ì—…ê³„ 100%, ìœ ì‚¬ì—…ì¢… 80% ë“±</small>
                </div>
                <div class="form-group">
                    <label>ì£¼ë‹¹ê·¼ë¬´ì‹œê°„</label>
                    <input type="number" id="careerWorkingHours-${careerCount}" class="form-control" value="40" min="1" max="40" placeholder="40">
                    <small class="form-hint">í’€íƒ€ì„ 40ì‹œê°„ ê¸°ì¤€ ë¹„ìœ¨ ì ìš©</small>
                </div>
            </div>
        `;
        
        // DOM ìƒì„±
        const careerDiv = document.createElement('div');
        careerDiv.className = 'career-section';
        careerDiv.id = `career-${careerCount}`;
        careerDiv.innerHTML = careerHTML;
        
        careerList.appendChild(careerDiv);
        
        ë¡œê±°_ì¸ì‚¬?.info('ê²½ë ¥ ì¶”ê°€ ì™„ë£Œ', { careerCount });
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ê²½ë ¥ ì¶”ê°€ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ê²½ë ¥ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('âŒ ê²½ë ¥ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

/**
 * ê²½ë ¥ ì…ë ¥ í¼ ì‚­ì œ
 * 
 * @param {number} id - ì‚­ì œí•  ê²½ë ¥ ID
 * 
 * @example
 * removeCareer(1); // ê²½ë ¥ 1 ì‚­ì œ
 */
function removeCareer(id) {
    try {
        ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ì‚­ì œ ì‹œë„', { id });
        
        const career = document.getElementById(`career-${id}`);
        
        if (career) {
            career.remove();
            ë¡œê±°_ì¸ì‚¬?.info('ê²½ë ¥ ì‚­ì œ ì™„ë£Œ', { id });
        } else {
            ë¡œê±°_ì¸ì‚¬?.warn('ì‚­ì œí•  ê²½ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', { id });
        }
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ê²½ë ¥ ì‚­ì œ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ê²½ë ¥ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

// ===== ë©”ì¸ ë“±ë¡ í•¨ìˆ˜ =====

/**
 * í˜¸ë´‰ ê³„ì‚° ë° ì§ì› ì •ë³´ ì €ì¥
 * 
 * ê²€ì¦ ë‹¨ê³„:
 * 1. í•„ìˆ˜ í•­ëª© ê²€ì¦
 * 2. ì‚¬ì›ë²ˆí˜¸ ì¤‘ë³µ ê²€ì¦
 * 3. ê³¼ê±° ê²½ë ¥ ë‚ ì§œ ê²€ì¦
 * 4. í˜¸ë´‰ ë²”ìœ„ ê²€ì¦
 * 5. ê³„ì‚°ëœ ë‚ ì§œ ê²€ì¦
 * 
 * @example
 * calculateAndSave(); // í¼ ë°ì´í„° ê²€ì¦ ë° ì €ì¥
 */
async function calculateAndSave() {
    try {
        ë¡œê±°_ì¸ì‚¬?.info('ì§ì› ë“±ë¡ ì‹œì‘');
        
        // ===== ì…ë ¥ê°’ ìˆ˜ì§‘ =====
        const getValue = (id) => {
            const elem = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
                ? DOMìœ í‹¸_ì¸ì‚¬.getById(id)
                : document.getElementById(id);
            return elem ? (elem.value || '').trim() : '';
        };
        
        const name = getValue('employeeName');
        const employeeNumber = getValue('employeeNumber');
        const dept = getValue('employeeDept');
        const position = getValue('employeePosition');
        const grade = getValue('employeeGrade');
        const jobType = getValue('employeeJobType');
        const entryDate = getValue('entryDate');
        const employmentType = getValue('employmentType');
        
        // â­ v3.2.0: ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„ ì¶”ê°€
        const weeklyWorkingHoursValue = getValue('weeklyWorkingHours');
        const weeklyWorkingHours = parseInt(weeklyWorkingHoursValue) || 40;
        
        const isRankBasedElem = document.querySelector('input[name="isRankBased"]:checked');
        const isRankBased = isRankBasedElem ? isRankBasedElem.value === 'true' : false;
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì…ë ¥ê°’ ìˆ˜ì§‘ ì™„ë£Œ', {
            name,
            dept,
            position,
            entryDate,
            weeklyWorkingHours,
            isRankBased
        });
        
        // ===== ê²€ì¦ 1: í•„ìˆ˜ í•­ëª© ê²€ì¦ (API) =====
        let validation;
        
        // API ê²€ì¦ ìš°ì„ , fallbackìœ¼ë¡œ ë¡œì»¬ ê²€ì¦
        if (typeof API_ì¸ì‚¬ !== 'undefined') {
            try {
                // ì¤‘ë³µ ê²€ì¦ì„ ìœ„í•œ ê¸°ì¡´ ì½”ë“œ ëª©ë¡ ìˆ˜ì§‘
                const employees = db.getAllEmployees() || [];
                const existingNumbers = employees
                    .filter(e => e.employeeNumber)
                    .map(e => e.employeeNumber);
                
                validation = await API_ì¸ì‚¬.validateRegistration(
                    { name, dept, position, grade, jobType, entryDate },
                    [],  // existingCodes (ê³ ìœ ë²ˆí˜¸ëŠ” ìë™ìƒì„±ì´ë¯€ë¡œ ë¹ˆ ë°°ì—´)
                    existingNumbers
                );
                ë¡œê±°_ì¸ì‚¬?.debug('API ê²€ì¦ ì™„ë£Œ', validation);
            } catch (apiError) {
                ë¡œê±°_ì¸ì‚¬?.warn('API ê²€ì¦ ì‹¤íŒ¨, ë¡œì»¬ ê²€ì¦ ì‚¬ìš©', apiError);
                // fallback: ë¡œì»¬ ê²€ì¦
                validation = Validator.validateEmployeeRegistration({
                    name, dept, position, grade, jobType, entryDate
                });
            }
        } else {
            // API_ì¸ì‚¬ ì—†ìœ¼ë©´ ë¡œì»¬ ê²€ì¦
            validation = Validator.validateEmployeeRegistration({
                name, dept, position, grade, jobType, entryDate
            });
        }
        
        if (!validation.valid) {
            ë¡œê±°_ì¸ì‚¬?.warn('í•„ìˆ˜ í•­ëª© ê²€ì¦ ì‹¤íŒ¨', { errors: validation.errors });
            
            const errorMsg = 'âš ï¸ í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.\n\n' + validation.errors.join('\n');
            
            if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(errorMsg);
            } else {
                alert(errorMsg);
            }
            return;
        }
        
        // ===== ê²€ì¦ 2: ì‚¬ì›ë²ˆí˜¸ ì¤‘ë³µ ê²€ì¦ =====
        if (employeeNumber && db.isEmployeeNumberDuplicate(employeeNumber)) {
            ë¡œê±°_ì¸ì‚¬?.warn('ì‚¬ì›ë²ˆí˜¸ ì¤‘ë³µ', { employeeNumber });
            
            const errorMsg = `âš ï¸ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì‚¬ì›ë²ˆí˜¸ì…ë‹ˆë‹¤: ${employeeNumber}`;
            
            if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(errorMsg);
            } else {
                alert(errorMsg);
            }
            return;
        }
        
        // ===== ê²½ë ¥ ìˆ˜ì§‘ =====
        const careers = [];
        
        for (let i = 1; i <= careerCount; i++) {
            const careerDiv = document.getElementById(`career-${i}`);
            if (!careerDiv) continue;
            
            const careerName = getValue(`careerName-${i}`);
            const careerStartDate = getValue(`careerStartDate-${i}`);
            const careerEndDate = getValue(`careerEndDate-${i}`);
            const careerRate = parseInt(getValue(`careerRate-${i}`)) || 100;
            const careerWorkingHours = parseInt(getValue(`careerWorkingHours-${i}`)) || 40;
            
            // ê²½ë ¥ ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
            if (careerName && careerStartDate && careerEndDate) {
                // ê²€ì¦ 3: ê²½ë ¥ ë‚ ì§œ ê²€ì¦
                if (careerEndDate < careerStartDate) {
                    ë¡œê±°_ì¸ì‚¬?.warn('ê²½ë ¥ ë‚ ì§œ ì˜¤ë¥˜', { careerName, careerStartDate, careerEndDate });
                    
                    const errorMsg = `âš ï¸ ê²½ë ¥ "${careerName}"ì˜ ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤.`;
                    
                    if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                        ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                    return;
                }
                
                careers.push({
                    name: careerName,
                    startDate: careerStartDate,
                    endDate: careerEndDate,
                    rate: careerRate,
                    workingHours: careerWorkingHours
                });
            }
        }
        
        ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ìˆ˜ì§‘ ì™„ë£Œ', { careerCount: careers.length });
        
        // ===== í˜¸ë´‰ ê³„ì‚° =====
        ë¡œê±°_ì¸ì‚¬?.debug('í˜¸ë´‰ ê³„ì‚° ì‹œì‘');
        
        // ê²½ë ¥ ê³„ì‚°
        const careerResult = CareerCalculator.calculateTotalCareer(careers);
        const totalYears = careerResult.years;
        const totalMonths = careerResult.months;
        const totalDays = careerResult.days;
        
        ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ê³„ì‚° ì™„ë£Œ', { totalYears, totalMonths, totalDays });
        
        // âœ… v4.0.0: ì…ì‚¬ í˜¸ë´‰ ê³„ì‚° - API ìš°ì„  ì‚¬ìš©
        let currentGrade;
        if (typeof API_ì¸ì‚¬ !== 'undefined') {
            currentGrade = await API_ì¸ì‚¬.calculateInitialRank(totalYears, totalMonths);
        } else {
            currentGrade = RankCalculator.calculateInitialRank(totalYears, totalMonths);
        }
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì…ì‚¬ í˜¸ë´‰ ê³„ì‚° ì™„ë£Œ', { currentGrade });
        
        // ê²€ì¦ 4: í˜¸ë´‰ ë²”ìœ„ ê²€ì¦
        const minRank = typeof CONFIG !== 'undefined' ? CONFIG.RANK.MIN : 1;
        const maxRank = typeof CONFIG !== 'undefined' ? CONFIG.RANK.MAX : 99;
        
        if (currentGrade < minRank || currentGrade > maxRank) {
            ë¡œê±°_ì¸ì‚¬?.warn('í˜¸ë´‰ ë²”ìœ„ ì´ˆê³¼', { currentGrade, minRank, maxRank });
            
            const errorMsg = `âš ï¸ ê³„ì‚°ëœ í˜¸ë´‰(${currentGrade})ì´ í—ˆìš© ë²”ìœ„(${minRank}~${maxRank})ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.`;
            
            if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(errorMsg);
            } else {
                alert(errorMsg);
            }
            return;
        }
        
        // âœ… v4.0.0: ì²«ìŠ¹ê¸‰ì¼ ê³„ì‚° - API ìš°ì„  ì‚¬ìš©
        let firstUpgradeDate;
        if (typeof API_ì¸ì‚¬ !== 'undefined') {
            firstUpgradeDate = await API_ì¸ì‚¬.calculateFirstUpgradeDate(
                entryDate, totalYears, totalMonths, totalDays
            );
        } else {
            firstUpgradeDate = RankCalculator.calculateFirstUpgradeDate(
                entryDate, totalYears, totalMonths, totalDays
            );
        }
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì²«ìŠ¹ê¸‰ì¼ ê³„ì‚° ì™„ë£Œ', { firstUpgradeDate });
        
        // âœ… v4.0.0: ì°¨ê¸°ìŠ¹ê¸‰ì¼ ê³„ì‚° - API ìš°ì„  ì‚¬ìš©
        let nextUpgradeDate;
        if (typeof API_ì¸ì‚¬ !== 'undefined') {
            nextUpgradeDate = await API_ì¸ì‚¬.calculateNextUpgradeDate(firstUpgradeDate);
        } else {
            nextUpgradeDate = RankCalculator.calculateNextUpgradeDate(firstUpgradeDate);
        }
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì°¨ê¸°ìŠ¹ê¸‰ì¼ ê³„ì‚° ì™„ë£Œ', { nextUpgradeDate });
        
        // ê²€ì¦ 5: ê³„ì‚°ëœ ë‚ ì§œ ê²€ì¦
        if (isRankBased && (!firstUpgradeDate || !nextUpgradeDate)) {
            ë¡œê±°_ì¸ì‚¬?.warn('ìŠ¹ê¸‰ì¼ ê³„ì‚° ì‹¤íŒ¨');
            
            const errorMsg = 'âš ï¸ ìŠ¹ê¸‰ì¼ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”.';
            
            if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
                ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.warn(errorMsg);
            } else {
                alert(errorMsg);
            }
            return;
        }
        
        // ===== ì§ì› ë°ì´í„° ìƒì„± =====
        const uniqueCode = db.generateUniqueCode();
        
        const employee = {
            id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
            uniqueCode: uniqueCode,
            employeeNumber: employeeNumber || '',
            
            personalInfo: {
                name: name
            },
            
            employment: {
                dept: dept,
                position: position,
                grade: grade || '',
                jobType: jobType || '',
                entryDate: entryDate,
                employmentType: employmentType || 'ì •ê·œì§',
                isRankBased: isRankBased,
                weeklyWorkingHours: weeklyWorkingHours
            },
            
            rank: isRankBased ? {
                startRank: currentGrade,      // â­ ì…ì‚¬ ì‹œ íšì • í˜¸ë´‰
                currentRank: currentGrade,
                firstUpgradeDate: firstUpgradeDate,
                nextUpgradeDate: nextUpgradeDate
            } : null,
            
            career: {
                totalYears: totalYears,
                totalMonths: totalMonths,
                totalDays: totalDays
            },
            
            careerDetails: careerResult.details.map((d, idx) => ({
                id: idx + 1,
                name: d.name,
                startDate: d.startDate,
                endDate: d.endDate,
                rate: d.rate,
                workingHours: d.workingHours,
                // â­ ì—°ëª…ë¶€ í˜¸í™˜ìš© ë¬¸ìì—´ í•„ë“œ ì¶”ê°€
                period: d.originalPeriod 
                    ? `${d.originalPeriod.years}ë…„ ${d.originalPeriod.months}ê°œì›” ${d.originalPeriod.days}ì¼` 
                    : '',
                converted: d.convertedPeriod 
                    ? `${d.convertedPeriod.years}ë…„ ${d.convertedPeriod.months}ê°œì›” ${d.convertedPeriod.days}ì¼` 
                    : ''
            })),
            
            // ì²« ë²ˆì§¸ ë°œë ¹ ê¸°ë¡ ìƒì„± - â­ v3.4.2: ì¸ì‚¬ë°œë ¹ ëª¨ë“ˆê³¼ ì¼ê´€ëœ êµ¬ì¡°
            assignments: [{
                id: `assign-${Date.now()}`,  // â­ ë¬¸ìì—´ IDë¡œ í†µì¼
                code: `${uniqueCode}-01`,    // â­ ë°œë ¹ ì½”ë“œ íŒ¨í„´: ê³ ìœ ë²ˆí˜¸-ìˆœë²ˆ
                startDate: entryDate,        // â­ ì¸ì‚¬ë°œë ¹ ëª¨ë“ˆê³¼ ë™ì¼ í•„ë“œëª…
                date: entryDate,             // í•˜ìœ„ í˜¸í™˜ìš©
                type: 'ì‹ ê·œì„ìš©',             // ë°œë ¹ ìœ í˜•
                dept: dept,
                position: position,
                grade: grade || '',
                rank: isRankBased ? currentGrade : null,
                workingHours: weeklyWorkingHours,
                paymentMethod: isRankBased ? 'í˜¸ë´‰ì œ' : 'ì—°ë´‰ì œ',  // â­ ê¸‰ì—¬ë°©ì‹ ì¶”ê°€
                isRankBased: isRankBased,    // â­ í˜¸ë´‰ì œ ì—¬ë¶€ ì¶”ê°€
                note: 'ì‹ ê·œ ì…ì‚¬',
                status: 'active'             // â­ í˜„ì¬ ë°œë ¹ ìƒíƒœ
            }],
            
            currentPosition: {
                dept: dept,
                position: position,
                grade: grade || '',
                assignmentDate: entryDate
            }
        };
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì§ì› ë°ì´í„° ìƒì„± ì™„ë£Œ', {
            uniqueCode,
            name,
            currentGrade
        });
        
        // ===== ì €ì¥ =====
        db.saveEmployee(employee);
        
        ë¡œê±°_ì¸ì‚¬?.info('ì§ì› ë“±ë¡ ì™„ë£Œ', {
            uniqueCode,
            employeeNumber,
            name,
            dept,
            position,
            currentGrade
        });
        
        // ì„±ê³µ ë©”ì‹œì§€
        const successMsg = `âœ… ${name}ë‹˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
            `ê³ ìœ ë²ˆí˜¸: ${uniqueCode}\n` +
            (employeeNumber ? `ì‚¬ì›ë²ˆí˜¸: ${employeeNumber}\n` : '') +
            `ì…ì‚¬ì¼: ${entryDate}\n` +
            (isRankBased ? `ì…ì‚¬ í˜¸ë´‰: ${currentGrade}í˜¸ë´‰` : '');
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.success(successMsg);
        } else {
            alert(successMsg);
        }
        
        // ê²°ê³¼ í‘œì‹œ
        displayCalculationResult(
            name, totalYears, totalMonths, totalDays,
            currentGrade, firstUpgradeDate, nextUpgradeDate,
            careerResult.details || [], isRankBased
        );
        
        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        updateUniqueCodeField();
        
        // í¼ ì´ˆê¸°í™”
        resetRegisterForm();
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ì§ì› ë“±ë¡ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ì§ì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('âŒ ì§ì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
        }
    }
}

// ===== í¼ ê´€ë¦¬ í•¨ìˆ˜ =====

/**
 * ë“±ë¡ í¼ ì´ˆê¸°í™”
 * ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
 * 
 * @example
 * resetRegisterForm(); // í¼ ì´ˆê¸°í™”
 */
function resetRegisterForm() {
    try {
        ë¡œê±°_ì¸ì‚¬?.debug('ë“±ë¡ í¼ ì´ˆê¸°í™” ì‹œì‘');
        
        const setValue = (id, value) => {
            const elem = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
                ? DOMìœ í‹¸_ì¸ì‚¬.getById(id)
                : document.getElementById(id);
            if (elem) {
                if (typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined') {
                    DOMìœ í‹¸_ì¸ì‚¬.setValue(elem, value);
                } else {
                    elem.value = value;
                }
            }
        };
        
        setValue('employeeName', '');
        setValue('employeeNumber', '');
        setValue('employeeDept', '');
        setValue('employeePosition', '');
        setValue('employeeGrade', '');
        setValue('employeeJobType', '');
        setValue('entryDate', DateUtils.formatDate(new Date()));
        
        // â­ v3.2.0: ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„ ì´ˆê¸°í™”
        setValue('weeklyWorkingHours', '40');
        setValue('monthlyWorkingHoursDisplay', '209ì‹œê°„');
        
        // â­ v3.3.0: ì‚¬ì›ë²ˆí˜¸ ìë™ìƒì„± ëª¨ë“œ ë¦¬ì…‹ ë° ì—…ë°ì´íŠ¸
        _isEmployeeNumberAutoGenerated = true;
        updateEmployeeNumberField();
        
        // â­ v3.4.1: ê²½ë ¥ ì—†ìŒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        const noCareerCheckbox = document.getElementById('noCareerCheckbox');
        const careerSection = document.getElementById('careerSection');
        if (noCareerCheckbox) {
            noCareerCheckbox.checked = false;
        }
        if (careerSection) {
            careerSection.classList.remove('hidden');
        }
        
        // ê²½ë ¥ ëª©ë¡ ì´ˆê¸°í™”
        const careerList = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
            ? DOMìœ í‹¸_ì¸ì‚¬.getById('careerList')
            : document.getElementById('careerList');
        
        if (careerList) {
            careerList.innerHTML = '';
        }
        
        careerCount = 0;
        addCareer();
        
        ë¡œê±°_ì¸ì‚¬?.info('ë“±ë¡ í¼ ì´ˆê¸°í™” ì™„ë£Œ');
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ë“±ë¡ í¼ ì´ˆê¸°í™” ì‹¤íŒ¨', error);
    }
}

// ===== ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ =====

/**
 * ê³„ì‚° ê²°ê³¼ í‘œì‹œ
 * í˜¸ë´‰ ê³„ì‚° ê²°ê³¼ë¥¼ UIì— í‘œì‹œ
 * 
 * @param {string} name - ì§ì› ì´ë¦„
 * @param {number} years - í™˜ì‚° ê²½ë ¥ (ë…„)
 * @param {number} months - í™˜ì‚° ê²½ë ¥ (ì›”)
 * @param {number} days - í™˜ì‚° ê²½ë ¥ (ì¼)
 * @param {number} currentGrade - ì…ì‚¬ í˜¸ë´‰
 * @param {string} firstUpgradeDate - ì²«ìŠ¹ê¸‰ì¼
 * @param {string} nextDate - ì°¨ê¸°ìŠ¹ê¸‰ì¼
 * @param {Array} details - ê²½ë ¥ ìƒì„¸ ë°°ì—´
 * @param {boolean} isRankBased - í˜¸ë´‰ì œ ì—¬ë¶€
 */
function displayCalculationResult(name, years, months, days, currentGrade, firstUpgradeDate, nextDate, details, isRankBased) {
    try {
        ë¡œê±°_ì¸ì‚¬?.debug('ê³„ì‚° ê²°ê³¼ í‘œì‹œ ì‹œì‘', { name, currentGrade });
        
        // â­ í˜¸ë´‰íšì •í‘œ ì¶œë ¥ìš© ë°ì´í„° ì €ì¥
        window.lastCalculationData = {
            name: name,
            dept: document.getElementById('employeeDept')?.value || '-',
            position: document.getElementById('employeePosition')?.value || '-',
            entryDate: document.getElementById('entryDate')?.value || '-',
            years: years,
            months: months,
            days: days,
            startRank: currentGrade,      // ì…ì‚¬ ì‹œ íšì • í˜¸ë´‰
            currentRank: currentGrade,    // í˜„ì¬ í˜¸ë´‰ (ì‹ ê·œ ë“±ë¡ì´ë¯€ë¡œ ë™ì¼)
            firstUpgradeDate: firstUpgradeDate,
            nextUpgradeDate: nextDate,
            careerDetails: details.map((d, idx) => ({
                id: idx + 1,
                name: d.name || 'ë¯¸ì…ë ¥',
                startDate: d.startDate || '',
                endDate: d.endDate || '',
                rate: d.rate || 100,
                workingHours: d.workingHours || 40,
                // ì›ë³¸ ê¸°ê°„ê³¼ í™˜ì‚° ê¸°ê°„ ì •ë³´ ì¶”ê°€
                originalPeriod: d.originalPeriod || null,
                convertedPeriod: d.convertedPeriod || null
            }))
        };
        ë¡œê±°_ì¸ì‚¬?.debug('í˜¸ë´‰íšì •í‘œ ì¶œë ¥ìš© ë°ì´í„° ì €ì¥ ì™„ë£Œ', window.lastCalculationData);
        
        const resultBox = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
            ? DOMìœ í‹¸_ì¸ì‚¬.getById('rankResult')
            : document.getElementById('rankResult');
        
        if (!resultBox) {
            ë¡œê±°_ì¸ì‚¬?.warn('ê²°ê³¼ í‘œì‹œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        // ê²½ë ¥ ìƒì„¸ HTML ìƒì„±
        let detailsHTML = '';
        if (details.length > 0) {
            details.forEach(d => {
                // XSS ë°©ì§€
                const safeName = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
                    ? DOMìœ í‹¸_ì¸ì‚¬.escapeHtml(d.name)
                    : d.name;
                
                // ê¸°ê°„ í‘œì‹œ í˜•ì‹ ì²˜ë¦¬
                const periodStr = d.originalPeriod 
                    ? `${d.originalPeriod.years}ë…„ ${d.originalPeriod.months}ê°œì›” ${d.originalPeriod.days}ì¼`
                    : (d.period || '-');
                const convertedStr = d.convertedPeriod
                    ? `${d.convertedPeriod.years}ë…„ ${d.convertedPeriod.months}ê°œì›” ${d.convertedPeriod.days}ì¼`
                    : (d.converted || '-');
                
                detailsHTML += `
                    <div style="background: white; border: 1.5px solid #e8ebed; padding: 18px; border-radius: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #1a1d1f; font-size: 15px;">${safeName}</div>
                        <div style="font-size: 13px; color: #6b7280; line-height: 1.6;">
                            ì‹¤ì œ ê·¼ë¬´ê¸°ê°„: ${periodStr}
                            <br>â†’ ì¸ì •ë¥  ${d.rate || 100}% ì ìš©: <span style="color: #667eea; font-weight: 600;">${convertedStr}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        // XSS ë°©ì§€
        const safeName = typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined'
            ? DOMìœ í‹¸_ì¸ì‚¬.escapeHtml(name)
            : name;
        
        // ê²°ê³¼ HTML ìƒì„±
        const resultHTML = `
            <div class="result-box">
                <h2 style="margin-bottom: 8px; font-size: 22px; font-weight: 600; color: #1a1d1f;">ğŸ“‹ í˜¸ë´‰ ê³„ì‚° ê²°ê³¼</h2>
                <p style="color: #6b7280; margin-bottom: 24px; font-size: 14px;">${safeName}</p>
                
                ${detailsHTML}
                
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">í™˜ì‚° ì´ ê²½ë ¥</div>
                        <div class="result-value">${years}<span class="result-unit">ë…„</span> ${months}<span class="result-unit">ê°œì›”</span> ${days}<span class="result-unit">ì¼</span></div>
                    </div>
                    <div class="result-item highlight">
                        <div class="result-label">ì…ì‚¬ í˜¸ë´‰</div>
                        <div class="result-value">${currentGrade}<span class="result-unit">í˜¸ë´‰</span></div>
                    </div>
                    ${isRankBased ? `
                    <div class="result-item highlight">
                        <div class="result-label">ì²«ìŠ¹ê¸‰ì¼</div>
                        <div class="result-value" style="font-size: 20px;">${firstUpgradeDate}</div>
                    </div>
                    <div class="result-item highlight">
                        <div class="result-label">ì°¨ê¸° ìŠ¹ê¸‰ì¼</div>
                        <div class="result-value" style="font-size: 20px;">${nextDate}</div>
                    </div>
                    ` : ''}
                </div>
                <div style="margin-top: 24px; text-align: center;">
                    <button class="btn btn-primary" onclick="showCertificateFromResult()">ğŸ“„ í˜¸ë´‰íšì •í‘œ ì¶œë ¥</button>
                </div>
            </div>
        `;
        
        resultBox.innerHTML = resultHTML;
        
        if (typeof DOMìœ í‹¸_ì¸ì‚¬ !== 'undefined') {
            DOMìœ í‹¸_ì¸ì‚¬.show(resultBox);
        } else {
            resultBox.style.display = 'block';
        }
        
        resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        ë¡œê±°_ì¸ì‚¬?.info('ê³„ì‚° ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ê³„ì‚° ê²°ê³¼ í‘œì‹œ ì‹¤íŒ¨', error);
        
        if (typeof ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬ !== 'undefined') {
            ì—ëŸ¬ì²˜ë¦¬_ì¸ì‚¬.handle(error, 'ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

// ===== ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ =====

ë¡œê±°_ì¸ì‚¬?.info('ì§ì›ë“±ë¡ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');

// ===== v3.2.0 ì¶”ê°€: ì›” ì†Œì •ê·¼ë¡œì‹œê°„ ê³„ì‚° í•¨ìˆ˜ =====
// ===== v3.3.0 ìˆ˜ì •: SalaryCalculator ê³µí†µ í•¨ìˆ˜ ì‚¬ìš© =====

/**
 * ì›” ì†Œì •ê·¼ë¡œì‹œê°„ ê³„ì‚°
 * 
 * @param {number} weeklyHours - ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„
 * @param {number} year - ì—°ë„ (ì†Œìˆ˜ì  ì²˜ë¦¬ ì„¤ì • ì°¸ì¡°ìš©)
 * @returns {number} ì›” ì†Œì •ê·¼ë¡œì‹œê°„
 * 
 * @description
 * ê³µì‹: (ì£¼ ê·¼ë¬´ì‹œê°„ + ì£¼íœ´ì‹œê°„) Ã— (365 Ã· 12 Ã· 7)
 * - ì£¼íœ´ì‹œê°„ = ì£¼ ê·¼ë¬´ì‹œê°„ Ã· 40 Ã— 8 (ì£¼ 15ì‹œê°„ ì´ìƒ ê·¼ë¬´ ì‹œ)
 * - ì£¼ 15ì‹œê°„ ë¯¸ë§Œ: ì£¼íœ´ìˆ˜ë‹¹ ì—†ìŒ
 * - ì†Œìˆ˜ì  ì²˜ë¦¬: ê¸‰ì—¬ì„¤ì •ì—ì„œ ì§€ì • (ì˜¬ë¦¼/ë°˜ì˜¬ë¦¼/ë²„ë¦¼)
 * 
 * @example
 * calculateMonthlyWorkingHours(40);  // ë°˜ì˜¬ë¦¼ â†’ 209
 * calculateMonthlyWorkingHours(25);  // ë°˜ì˜¬ë¦¼ â†’ 130
 * calculateMonthlyWorkingHours(35);  // ë°˜ì˜¬ë¦¼ â†’ 183
 */
function calculateMonthlyWorkingHours(weeklyHours, year = null) {
    try {
        // SalaryCalculatorê°€ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
        if (typeof SalaryCalculator !== 'undefined' && SalaryCalculator.getMonthlyWorkingHours) {
            return SalaryCalculator.getMonthlyWorkingHours(weeklyHours, year);
        }
        
        // fallback: SalaryCalculatorê°€ ì—†ëŠ” ê²½ìš° ì§ì ‘ ê³„ì‚° (ë°˜ì˜¬ë¦¼)
        const hours = parseInt(weeklyHours) || 40;
        const weeksPerMonth = 365 / 7 / 12;  // 4.345238...
        
        if (hours < 15) {
            return Math.round(hours * weeksPerMonth);
        }
        
        const weeklyRestHours = (hours / 40) * 8;
        return Math.round((hours + weeklyRestHours) * weeksPerMonth);
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ì›” ì†Œì •ê·¼ë¡œì‹œê°„ ê³„ì‚° ì‹¤íŒ¨', error);
        return 209; // ê¸°ë³¸ê°’
    }
}

/**
 * ì›” ì†Œì •ê·¼ë¡œì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
 * 
 * @description
 * ì£¼ ì†Œì •ê·¼ë¡œì‹œê°„ ì…ë ¥ ì‹œ ì›” ì†Œì •ê·¼ë¡œì‹œê°„ì„ ìë™ ê³„ì‚°í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.
 * 
 * @example
 * // HTML: onchange="updateMonthlyHoursDisplay()"
 */
function updateMonthlyHoursDisplay() {
    try {
        const weeklyHoursElem = document.getElementById('weeklyWorkingHours');
        const monthlyDisplayElem = document.getElementById('monthlyWorkingHoursDisplay');
        
        if (!weeklyHoursElem || !monthlyDisplayElem) {
            ë¡œê±°_ì¸ì‚¬?.warn('ì›” ì†Œì •ê·¼ë¡œì‹œê°„ í‘œì‹œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        const weeklyHours = parseInt(weeklyHoursElem.value) || 40;
        const monthlyHours = calculateMonthlyWorkingHours(weeklyHours);
        
        monthlyDisplayElem.value = monthlyHours + 'ì‹œê°„';
        
        ë¡œê±°_ì¸ì‚¬?.debug('ì›” ì†Œì •ê·¼ë¡œì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸', {
            weeklyHours,
            monthlyHours
        });
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ì›” ì†Œì •ê·¼ë¡œì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', error);
    }
}

// ===== v3.4.1 ì¶”ê°€: ê²½ë ¥ ì—†ìŒ í† ê¸€ =====

/**
 * ê²½ë ¥ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
 * "ê²½ë ¥ ì—†ìŒ" ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ê²½ë ¥ ì…ë ¥ í¼ì„ ìˆ¨ê¸°ê±°ë‚˜ í‘œì‹œ
 * 
 * @example
 * // HTML: onchange="toggleCareerSection()"
 */
function toggleCareerSection() {
    try {
        const checkbox = document.getElementById('noCareerCheckbox');
        const careerSection = document.getElementById('careerSection');
        
        if (!checkbox || !careerSection) {
            ë¡œê±°_ì¸ì‚¬?.warn('ê²½ë ¥ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        if (checkbox.checked) {
            careerSection.classList.add('hidden');
            ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ì„¹ì…˜ ìˆ¨ê¹€ (ê²½ë ¥ ì—†ìŒ ì„ íƒ)');
        } else {
            careerSection.classList.remove('hidden');
            ë¡œê±°_ì¸ì‚¬?.debug('ê²½ë ¥ ì„¹ì…˜ í‘œì‹œ');
        }
        
    } catch (error) {
        ë¡œê±°_ì¸ì‚¬?.error('ê²½ë ¥ ì„¹ì…˜ í† ê¸€ ì‹¤íŒ¨', error);
    }
}
